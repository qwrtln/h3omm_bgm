<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HoMM3 Companion</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@pwabuilder/pwaupdate"></script>
  
  <style>
    :root {
      --bg-color: #1a1a1a;
      --btn-size: 130px;
      --gold-color: #FFD700; 
      --gold-gradient: linear-gradient(45deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C,#FCF6BA, #B38728, #FBF5B7, #AA771C);
      --faction-color: #333; 
    }

    body {
      background-color: var(--bg-color);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
    }

    #game-frame {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 9999;
        border: 7px solid;
        border-image-source: var(--gold-gradient);
        border-image-slice: 4;
        box-shadow: 
            inset 0 0 0 10px var(--faction-color),
            inset 0 0 10px rgba(0,0,0,0.5);
        transition: box-shadow 0.5s ease;
    }

    .screen {
      display: none; 
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      gap: 15px;
      box-sizing: border-box;
      padding: 30px; 
    }

    h1, h2 {
      font-size: 1.8rem;
      margin: 5px;
      color: var(--gold-color);
      text-transform: uppercase;
      text-shadow: 2px 2px 0px #000, 0 0 10px rgba(255, 215, 0, 0.5);
      letter-spacing: 1px;
      text-align: center;
    }

    .name-edit-container { display: flex; align-items: center; justify-content: center; gap: 15px; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 10px; border: 1px solid #444; }
    .edit-icon { cursor: pointer; font-size: 1.5rem; color: white; transition: transform 0.2s; background: #333; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--gold-color); box-shadow: 0 2px 5px black; pointer-events: auto; }
    .edit-icon:active { transform: scale(0.9); background: #555; }
    .grid-2x2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .grid-3col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .grid-3col .btn { height: 100px; }
    .grid-3col .btn-wrapper { width: 100px; }
    .horizontal-action-row { display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: flex-start; gap: 15px; width: 100%; }
    .overworld-layout { display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100vw; }
    #overworld-faction-subtitle { font-size: 1.1rem; color: var(--faction-color); text-transform: uppercase; font-weight: bold; letter-spacing: 2px; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0px 0px 5px rgba(0,0,0,0.8); margin-top: -15px; margin-bottom: -5px; z-index: 10; }
    #overworld-title { margin-bottom: 10px; }
    .grid-top-quadrant { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; position: relative; width: fit-content; }
    .faction-container { display: flex; flex-direction: column; gap: 8px; align-items: center; }
    .faction-row { display: flex; gap: 10px; justify-content: center; }
    .btn-wrapper { display: flex; flex-direction: column; align-items: center; width: var(--btn-size); }
    .btn-label { font-size: 0.8rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; margin-bottom: 4px; text-align: center; white-space: nowrap; overflow: hidden; width: 100%; }
    .btn { width: 100%; height: var(--btn-size); border: 2px solid #555; border-radius: 15px; background-size: cover; background-position: center; background-repeat: no-repeat; background-color: #333; box-shadow: 0 5px 8px rgba(0,0,0,0.6); cursor: pointer; transition: transform 0.1s; }
    .btn:active { transform: scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.6); }
    #click-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; cursor: pointer; }
    #event-overlay { position: fixed; inset: 0; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.7); background-image: url('assets/newtime.avif'); background-repeat: no-repeat; background-position: center; background-size: 300px 300px; }
    #event-text { font-size: 1.8rem; color: var(--gold-color); text-shadow: 3px 3px 0 #000; text-align: center; font-weight: bold; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px; max-width: 90%; }
    .counter-box { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    #p-count-display { font-size: 4rem; font-weight: bold; color: white; }
    .control-row { display: flex; gap: 20px; }
    .ctrl-btn { font-size: 2rem; width: 60px; height: 60px; border-radius: 10px; background: #444; border: 1px solid gold; color: gold; }
    .btn-good { background-image: url('assets/good.avif'); }
    .btn-evil { background-image: url('assets/evil.avif'); }
    .btn-neutral { background-image: url('assets/neutral.avif'); }
    .btn-secret { background-image: url('assets/secret.avif'); }
    .btn-castle { background-image: url('assets/castle.avif'); }
    .btn-rampart { background-image: url('assets/rampart.avif'); }
    .btn-tower { background-image: url('assets/tower.avif'); }
    .btn-inferno { background-image: url('assets/inferno.avif'); }
    .btn-dungeon { background-image: url('assets/dungeon.avif'); }
    .btn-necropolis { background-image: url('assets/necropolis.avif'); }
    .btn-fortress { background-image: url('assets/fortress.avif'); }
    .btn-stronghold { background-image: url('assets/stronghold.avif'); }
    .btn-conflux { background-image: url('assets/conflux.avif'); }
    .btn-cove { background-image: url('assets/cove.avif'); }
    .btn-factory { background-image: url('assets/factory.avif'); }
    .btn-dirt { background-image: url('assets/dirt.avif'); }
    .btn-grass { background-image: url('assets/grass.avif'); }
    .btn-lava { background-image: url('assets/lava.avif'); }
    .btn-rough { background-image: url('assets/rough.avif'); }
    .btn-sand { background-image: url('assets/sand.avif'); }
    .btn-snow { background-image: url('assets/snow.avif'); }
    .btn-swamp { background-image: url('assets/swamp.avif'); }
    .btn-underground { background-image: url('assets/underground.avif'); }
    .btn-water { background-image: url('assets/water.avif'); }
    .btn-wasteland { background-image: url('assets/wasteland.avif'); }
    .btn-start { background-image: url('assets/start.avif'); }
    .btn-resource { background-image: url('assets/resource.avif'); }
    .btn-valuable { background-image: url('assets/valuables.svg'); background-size: contain; background-repeat: no-repeat; background-position: center; }
    .btn-gold { background-image: url('assets/treasure.svg'); background-size: contain; background-repeat: no-repeat; background-position: center; }
    .btn-artifact { background-image: url('assets/artifact.svg');  background-size: contain; background-repeat: no-repeat; background-position: center; }
    .btn-endturn { background-image: url('assets/end_turn.avif'); }
    .btn-rules { background-image: url('assets/rules.avif'); }
    .btn-wingame { background-image: url('assets/win_game.avif'); }
    .btn-losegame { background-image: url('assets/lose.avif'); }
    .btn-eliminated { background-image: url('assets/eliminated.avif'); }
    .btn-victory { background-image: url('assets/victory.avif'); }
    .btn-retreat { background-image: url('assets/retreat.avif'); }
    .btn-surrender { background-image: url('assets/surrender.avif'); }
    .btn-lose { background-image: url('assets/eliminated.avif'); }
    .btn-confirm { background-color: #28a745; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
    .btn.disabled { filter: brightness(0.4); cursor: not-allowed; pointer-events: none; border-color: #333; }
    
    /* Stats Screen Styles */
    .stats-container {
        display: flex; flex-direction: column; width: 100%; max-width: 500px;
        background: rgba(0,0,0,0.6); padding: 10px 15px; border-radius: 15px; border: 1px solid #444; max-height: 85vh; overflow-y: auto; gap: 2px;
    }
    .stats-container h2 { margin: 4px 0 2px 0; font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.3); text-align: left; }

    .stats-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
    .stats-table th { text-align: left; color: var(--gold-color); font-size: 0.85rem; padding: 2px 0; }
    .stats-table td { text-align: right; font-size: 0.95rem; padding: 2px 0; }
    .stat-card-header { display: flex; align-items: center; gap: 12px; margin-top: 5px; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #444; }
    .stat-faction-icon { width: 44px; height: 44px; border-radius: 50%; background-size: cover; border: 2px solid var(--gold-color); flex-shrink: 0; }
    .stat-player-info { display: flex; flex-direction: column; line-height: 1.2; }
    .stat-player-name { font-weight: bold; font-size: 1.1rem; }
    .stat-player-faction { font-size: 0.8rem; color: #ccc; }
    .stats-nav { 
        display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 5px; padding-top: 5px; border-top: 1px solid #444;
    }
    .stat-icon { display: inline-block; width: 1.5em; height: 1.5em; vertical-align: text-bottom; background-position: center; margin: 0 1px; }
    .nav-arrow { font-size: 1.8rem; cursor: pointer; color: var(--gold-color); user-select: none; padding: 0 15px; }
    .nav-arrow:active { transform: scale(0.9); }
    .export-btn { 
        padding: 6px 15px; background: #333; border: 1px solid var(--gold-color); color: white; border-radius: 5px; cursor: pointer; 
    }
    .export-btn:active { background: #555; }
    
    @media (max-width: 430px) { :root { --btn-size: 110px; } .grid-3col .btn { height: 90px; } .grid-3col .btn-wrapper { width: 90px; } }
    @media (max-width: 350px) { :root { --btn-size: 95px; } .grid-3col .btn { height: 80px; } .grid-3col .btn-wrapper { width: 80px; } }
    @media (max-height: 700px) { .screen { gap: 8px; } h1,h2 { font-size: 1.4rem; } }

    /* --- OPTIONS MENU STYLES --- */

    /* Toggle Button (Mobile Only) */
    #options-btn {
        position: fixed;
        top: 25px;
        right: 25px;
        font-size: 2rem;
        z-index: 10002;
        cursor: pointer;
        filter: drop-shadow(0 0 2px gold);
        display: none; /* Desktop hidden by default via media query */
    }

    /* Options Menu Container */
    #options-menu {
        position: fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        background: rgba(0, 0, 0, 0.95);
        padding: 20px;
        z-index: 10001;
    }

    /* Wrapper for Mute + Slider (Row on Mobile, Col on Desktop) */
    .vol-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    #mute-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; filter: drop-shadow(0 0 2px gold); color: white; }
    #mute-btn.is-muted { filter: grayscale(1); opacity: 0.7; }

    .slider-container { position: relative; display: flex; align-items: center; justify-content: center; }

    #volume-slider { 
        -webkit-appearance: none; appearance: none; background: transparent; 
        cursor: pointer; outline: none; 
    }

    /* Chrome/Safari Track */
    #volume-slider::-webkit-slider-runnable-track { height: 8px; background: #111; border: 1px solid #444; border-radius: 4px; }
    /* Firefox Track */
    #volume-slider::-moz-range-track { height: 8px; background: #111; border: 1px solid #444; border-radius: 4px; }

    /* Thumb */
    #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #15a5e2; border: 2px solid #dcdcdc; margin-top: -9px; }
    #volume-slider::-moz-range-thumb { height: 24px; width: 24px; border-radius: 50%; background: #15a5e2; border: 2px solid #dcdcdc; border: none; }

    /* Autoplay Toggle */
    .autoplay-container { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%; border-top: 1px solid #444; padding-top: 15px; }
    .autoplay-label { font-size: 0.9rem; color: #ccc; text-align: center; }
    .toggle-btn {
        width: 50px; height: 26px; background: #333; border-radius: 13px; position: relative; cursor: pointer; border: 2px solid #555;
    }
    .toggle-btn::after {
        content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: #888; border-radius: 50%; transition: 0.3s;
    }
    .toggle-btn.active { background: #28a745; border-color: #28a745; }
    .toggle-btn.active::after { left: 26px; background: white; }

    /* Language Selection */
    .lang-wrapper {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border-top: 1px solid #444; padding-top: 15px; width: 100%; position: relative;
    }
    #lang-btn {
        font-size: 1.8rem; cursor: pointer; filter: drop-shadow(0 0 2px gold);
        transition: transform 0.2s;
    }
    #lang-btn:active { transform: scale(0.9); }

    #lang-submenu {
        display: none; /* Toggled via JS */
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
        background: #222;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #444;
    }

    .lang-option {
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px;
        border-radius: 5px;
        background: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    .lang-option:hover { background: #555; }

    /* Github Link */
    .github-link { margin-top: 5px; font-size: 0.85rem; color: #BF953F; text-decoration: none; border-bottom: 1px dashed #BF953F; padding-bottom: 2px; }
    .github-link:hover { color: white; border-color: white; }

    /* Desktop View (Sidebar) */
    @media (min-width: 1025px) {
        #options-btn { display: none; }
        #options-menu {
            right: 20px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 60px;
            padding: 20px 10px;
            border: 2px solid #555;
            box-shadow: 0 0 0 2px #BF953F, 0 0 15px black;
            border-radius: 20px;
        }
        .vol-wrapper {
            flex-direction: column;
        }
        /* Vertical slider for Desktop */
        .slider-container { width: 30px; height: 150px; }
        #volume-slider { width: 150px; height: 30px; transform: rotate(-90deg); transform-origin: center; }
        .autoplay-label { font-size: 0.7rem; }
        
        /* Desktop Lang Menu pops out to the left */
        #lang-submenu {
            position: absolute;
            right: 80px;
            top: 50%;
            transform: translateY(-50%);
            width: 150px;
            margin-top: 0;
            box-shadow: 0 0 10px black;
            border: 1px solid #BF953F;
        }
    }

    /* Mobile View (Overlay) */
    @media (max-width: 1024px) {
        #options-btn { display: block; }
        
        #options-menu {
            display: none; /* Hidden by default, toggled via JS */
            position: fixed;
            top: 7px; right: 7px; bottom: 7px; left: 7px; 
            width: auto; height: auto;
            transform: none;
            justify-content: center;
            border: none;
            box-shadow: none;
            border-radius: 0;
            overflow-y: auto; /* Allow scrolling if menu is tall */
        }

        .vol-wrapper {
            flex-direction: row; /* Horizontal layout */
            width: 100%;
            justify-content: center;
        }

        /* Horizontal slider for Mobile */
        .slider-container { width: 60%; height: auto; }
        #volume-slider { width: 100%; height: 30px; transform: none; margin: 0; }

        .autoplay-label { font-size: 1.1rem; }
        .toggle-btn { width: 60px; height: 32px; border-radius: 16px; }
        .toggle-btn::after { width: 24px; height: 24px; top: 2px; left: 2px; }
        .toggle-btn.active::after { left: 30px; }

        /* Mobile Lang Menu is inline */
        .lang-wrapper { width: 80%; }
        #lang-submenu { width: 100%; box-sizing: border-box; }
    }

    /* --- TIMELINE STYLES --- */
    #timeline-overlay { position: fixed; inset: 0; z-index: 20000; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; overflow-y: scroll; scroll-behavior: smooth; }
    .timeline-title-bar { position: fixed; top: 0; left: 0; width: 100%; background: #111; border-bottom: 2px solid var(--gold-color);
        padding: 15px; text-align: center; z-index: 20001; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; 
    }
    .timeline-close { font-size: 2rem; cursor: pointer; color: white; }
    #timeline-container { position: relative; width: 100%; max-width: 600px; margin-top: 80px; margin-bottom: 50px; min-height: 100%; display: flex; justify-content: center; }
    #timeline-content { position: relative; width: 100%; }
    .t-bar { position: absolute; left: 50%; width: 6px; transform: translateX(-3px); }
    .t-node { position: absolute; width: 40px; height: 40px; background-size: contain; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px black; background-color: #333; background-repeat: no-repeat; background-position: center; }
    .t-center { left: 50%; transform: translate(-50%, 50%); z-index: 5; background-size: contain; background-repeat: no-repeat; background-position: center; }
    .t-small { width: 24px; height: 24px; border: 1px solid #ccc; background-size: contain; background-repeat: no-repeat; background-position: center; }
    .t-large { width: 60px; height: 60px; border: 3px solid gold; background-size: contain; background-repeat: no-repeat; background-position: center; }
    .t-leaf { top: auto; z-index: 4; background-size: contain; background-repeat: no-repeat; background-position: center; }
    .t-left { left: 50%; transform: translate(-150%, 50%); background-size: contain; background-repeat: no-repeat; background-position: center; }
    .t-right { left: 50%; transform: translate(50%, 50%); background-size: contain; background-repeat: no-repeat; background-position: center; }
    .t-battle-bracket { position: absolute; left: 50%; width: 40px; border: 2px solid #a00; border-left: none; transform: translateX(0); z-index: 2; }
  </style>
</head>
<body>

  <pwa-update swpath="sw.js"></pwa-update>

  <div id="game-frame"></div>

  <div id="click-overlay" onclick="Game.init()">
    <h1 data-i18n="app_title">H3 Board Game<br>Music Companion</h1>
    <p style="color: #ccc;" data-i18n="click_setup">Click to Setup</p>
  </div>

  <!-- SCREEN 1: Theme -->
  <div id="screen-start" class="screen">
    <h1 data-i18n="screen_theme_title">Select Mission Theme</h1>
    <div class="grid-2x2">
        <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_good">Good</span><div class="btn btn-good" onclick="Game.selectTheme('good')"></div></div>
        <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_evil">Evil</span><div class="btn btn-evil" onclick="Game.selectTheme('evil')"></div></div>
        <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_neutral">Neutral</span><div class="btn btn-neutral" onclick="Game.selectTheme('neutral')"></div></div>
        <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_secret">Secret</span><div class="btn btn-secret" onclick="Game.selectTheme('secret')"></div></div>
    </div>
  </div>

  <!-- SCREEN 2: Player Count -->
  <div id="screen-players" class="screen">
    <h1 data-i18n="screen_players_title">Player Count</h1>
    <div class="counter-box">
        <div class="control-row">
            <button class="ctrl-btn" onclick="updateCount(-1)">-</button>
            <div id="p-count-display">3</div>
            <button class="ctrl-btn" onclick="updateCount(1)">+</button>
        </div>
        <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_confirm">Confirm</span><div class="btn btn-confirm" onclick="Game.confirmPlayerCount(currentPlayerCount)">‚úÖ</div></div>
    </div>
  </div>

  <!-- SCREEN 3: Faction Selection -->
  <div id="screen-factions" class="screen">
    <div class="name-edit-container">
        <h2 id="faction-player-title">Player 1</h2>
        <div class="edit-icon" onclick="Game.editName()">‚úèÔ∏è</div>
    </div>
    
    <div class="faction-container">
        <div class="faction-row">
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_castle">Castle</span><div class="btn btn-castle faction-btn" data-faction="castle"></div></div>
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_rampart">Rampart</span><div class="btn btn-rampart faction-btn" data-faction="rampart"></div></div>
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_tower">Tower</span><div class="btn btn-tower faction-btn" data-faction="tower"></div></div>
        </div>
        <div class="faction-row">
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_inferno">Inferno</span><div class="btn btn-inferno faction-btn" data-faction="inferno"></div></div>
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_dungeon">Dungeon</span><div class="btn btn-dungeon faction-btn" data-faction="dungeon"></div></div>
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_necropolis">Necropolis</span><div class="btn btn-necropolis faction-btn" data-faction="necropolis"></div></div>
        </div>
        <div class="faction-row">
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_fortress">Fortress</span><div class="btn btn-fortress faction-btn" data-faction="fortress"></div></div>
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_stronghold">Stronghold</span><div class="btn btn-stronghold faction-btn" data-faction="stronghold"></div></div>
        </div>
        <div class="faction-row">
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_conflux">Conflux</span><div class="btn btn-conflux faction-btn" data-faction="conflux"></div></div>
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_cove">Cove</span><div class="btn btn-cove faction-btn" data-faction="cove"></div></div>
            <div class="btn-wrapper"><span class="btn-label" data-i18n="faction_factory">Factory</span><div class="btn btn-factory faction-btn" data-faction="factory"></div></div>
        </div>
    </div>
  </div>

  <!-- SCREEN 3.5: Pre-Game -->
  <div id="screen-pregame" class="screen">
      <h1 data-i18n="ready_title">Ready?</h1>
      <div class="btn-wrapper">
          <span class="btn-label" data-i18n="btn_start_game">Start Game</span>
          <div class="btn btn-start" style="transform: scale(1.5);" onclick="Game.startGame()"></div>
      </div>
  </div>

    <!-- SCREEN 4: Overworld -->
    <div id="screen-overworld" class="screen">
        <h1 id="overworld-title">Player 1's Turn</h1>
        <div id="overworld-faction-subtitle">Castle</div> 
        <div class="overworld-layout">

          <div class="grid-top-quadrant">
              <div id="event-overlay" onclick="Game.skipEventOverlay()">
                  <div id="event-text"></div>
              </div>
              <div id="resource-popup" onclick="if(event.target === this) this.style.display='none'" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10001; flex-direction:column; justify-content:center; align-items:center;">
                  <div style="background: var(--bg-color); padding: 30px; border-radius: 15px; border: 2px solid var(--gold-color); display: flex; flex-direction: column; align-items: center; gap: 15px; box-shadow: 0 0 20px black;">
                      <h2 style="font-size: 1.2rem;" data-i18n="select_pickup_title">Select Pickup</h2>
                      <div class="control-row">
                          <div class="btn-wrapper">
                              <span class="btn-label" data-i18n="btn_treasure">Treasure</span>
                              <div class="btn btn-gold" onclick="Game.handleResourceChoice('gold')"></div>
                          </div>
                          <div class="btn-wrapper">
                              <span class="btn-label" data-i18n="btn_resource">Resource</span>
                              <div class="btn btn-valuable" onclick="Game.handleResourceChoice('valuable')"></div>
                          </div>
                      </div>
                      <div class="btn-wrapper">
                          <span class="btn-label" data-i18n="btn_artifact">Artifact</span>
                          <div class="btn btn-artifact" onclick="Game.handleResourceChoice('artifact')"></div>
                      </div>
                  </div>
              </div>
              <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_battle">Battle</span><div class="btn btn-start" onclick="Game.startCombat()"></div></div>
              <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_pickup">Pickup</span><div class="btn btn-resource" onclick="Game.handleResource()"></div></div>
              <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_eliminate">Eliminate Player</span><div class="btn btn-eliminated" onclick="Game.askEliminate()"></div></div>
              <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_end_turn">End Turn</span><div class="btn btn-endturn" onclick="Game.endTurn()"></div></div>
          </div>

          <!-- Theme Button Updated -->
          <div class="horizontal-action-row">
              <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_rules">Rules</span><div class="btn btn-rules" onclick="Game.showRules('screen-overworld')"></div></div>
              <div class="btn-wrapper">
                  <span class="btn-label" data-i18n="btn_change_theme">Change Theme</span>
                  <!-- Image will be updated via JS to match current theme -->
                  <div id="btn-theme-toggle" class="btn" onclick="Game.openThemeSelector()"></div>
              </div>
          </div>

          <div class="horizontal-action-row">
              <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_win_scenario">Win Scenario</span><div class="btn btn-wingame" onclick="Game.winGame()"></div></div>
              <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_lose_scenario">Lose Scenario</span><div class="btn btn-losegame" onclick="Game.loseGame()"></div></div>
          </div>
        </div>
    </div>

  <!-- 4.5: Theme Selector -->
  <div id="screen-theme-select" class="screen">
      <h1 data-i18n="select_theme_title">Select Theme</h1>
      
      <!-- Row 1: Faction Town -->
      <div class="btn-wrapper">
          <span class="btn-label" id="theme-faction-label">Town</span>
          <div id="theme-faction-btn" class="btn"></div>
      </div>

      <!-- Rows 2-4: Terrains (Grid) -->
      <div class="grid-3col">
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_dirt">Dirt</span><div class="btn btn-dirt" onclick="Game.applyThemeSelection('dirt')"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_grass">Grass</span><div class="btn btn-grass" onclick="Game.applyThemeSelection('grass')"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_lava">Lava</span><div class="btn btn-lava" onclick="Game.applyThemeSelection('lava')"></div></div>
          
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_rough">Rough</span><div class="btn btn-rough" onclick="Game.applyThemeSelection('rough')"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_sand">Sand</span><div class="btn btn-sand" onclick="Game.applyThemeSelection('sand')"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_snow">Snow</span><div class="btn btn-snow" onclick="Game.applyThemeSelection('snow')"></div></div>
          
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_swamp">Swamp</span><div class="btn btn-swamp" onclick="Game.applyThemeSelection('swamp')"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_underground">Underground</span><div class="btn btn-underground" onclick="Game.applyThemeSelection('underground')"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_water">Water</span><div class="btn btn-water" onclick="Game.applyThemeSelection('water')"></div></div>

          <div class="btn-wrapper"></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="terrain_wasteland">Wasteland</span><div class="btn btn-wasteland" onclick="Game.applyThemeSelection('wasteland')"></div></div>
      </div>
  </div>

  <!-- SCREEN 5: Combat -->
  <div id="screen-combat" class="screen">
    <h1 id="combat-title" data-i18n="combat_title_generic">Combat</h1>
    
    <div style="position: relative;">
      <div id="combat-event-overlay" onclick="Game.returnToOverworld()" style="
        position: absolute;
        inset: -10px;
        background-color: rgba(0,0,0,0.8);
        background-repeat: no-repeat;
        background-position: center;
        background-size: cover;
        z-index: 900;
        border-radius: 20px;
        box-shadow: 0 0 15px #000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 2px solid var(--gold-color);
        cursor: pointer; 
      ">
        <div id="combat-event-text" style="
          font-size: 1.8rem;
          color: var(--gold-color);
          text-shadow: 3px 3px 0 #000;
          text-align: center;
          font-weight: bold;
          background: rgba(0,0,0,0.6);
          padding: 10px;
          border-radius: 10px;
        "></div>
      </div>

      <div class="grid-2x2">
          <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_win">Win</span><div class="btn btn-victory" onclick="Game.combatVictory()"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_retreat">Retreat</span><div class="btn btn-retreat" onclick="Game.combatRetreat()"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_lose">Lose</span><div class="btn btn-lose" onclick="Game.combatLose()"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_surrender">Surrender</span><div class="btn btn-surrender" onclick="Game.combatSurrender()"></div></div>
          <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_rules">Rules</span><div class="btn btn-rules" onclick="Game.showRules('screen-combat')"></div></div>
      </div>
    </div>
  </div>

  <!-- SCREEN 6: Rules -->
  <div id="screen-rules" class="screen">
      <h1 data-i18n="rules_title">Consulting Rules</h1>
      <div class="btn-wrapper"><span class="btn-label" data-i18n="btn_back">Back</span><div class="btn btn-rules" style="transform: scale(1.5);" onclick="Game.exitRules()"></div></div>
  </div>

  <!-- SCREEN 7: Win/Lose Result -->
  <div id="screen-win" class="screen">
      <h1 id="endgame-title" data-i18n="victory_title">Victory!</h1>
      <div class="grid-2x2" style="justify-items: center;">
          <div class="btn-wrapper">
              <span class="btn-label" data-i18n="btn_new_game">New Game</span>
              <div id="win-theme-btn" class="btn" onclick="Game.resetGame()"></div>
          </div>
          <div class="btn-wrapper">
             <span class="btn-label" data-i18n="btn_view_stats">Stats</span>
             <div class="btn btn-resource" onclick="Game.showStats(Game.state.statsViewIndex)"></div>
         </div>
      </div>
  </div>

  <!-- SCREEN 8: Statistics -->
   <div id="screen-stats" class="screen">
      <h1 data-i18n="screen_stats_title">Mission Stats</h1>
      <div class="stats-container">
          <h2 style="font-size: 1rem; border-bottom: 1px solid white;" data-i18n="stat_global_header">Global</h2>
          <table class="stats-table">
              <tr><th data-i18n="stat_setup_time">Setup Time</th><td id="stat-setup">0m 0s</td></tr>
              <tr><th data-i18n="stat_game_time">Total Time</th><td id="stat-game-total">0m 0s</td></tr>
              <tr><th data-i18n="stat_rules_time">Rules Time</th><td id="stat-rules">0m 0s</td></tr>
          </table>
          <h2 style="font-size: 1rem; border-bottom: 1px solid white;" data-i18n="stat_player_header">Player</h2>
          <div class="stat-card-header">
              <div id="stat-p-img" class="stat-faction-icon"></div>
              <div class="stat-player-info">
                  <span id="stat-p-name" class="stat-player-name">Player 1</span>
                  <span id="stat-p-faction" class="stat-player-faction">Castle</span>
              </div>
          </div>
          <table class="stats-table">
              <tr><th data-i18n="stat_avg_turn">Avg Turn</th><td id="stat-avg-turn">0m 0s</td></tr>
              <tr><th data-i18n="stat_total_battle">Battle Time</th><td id="stat-battle-total">0m 0s</td></tr>
              <tr><th><span data-i18n="stat_combat_record">Combat</span> (<span data-i18n="btn_win">Win</span>/<span data-i18n="btn_retreat">Retreat</span>/<span data-i18n="btn_lose">Lose</span>/<span data-i18n="btn_surrender">Surrender</span>)</th>
                  <td id="stat-combat-rec">0 / 0 / 0 / 0</td></tr>
              <tr><th><span data-i18n="stat_loot">Loot</span> (<span class="stat-icon btn-gold"></span>/<span class="stat-icon btn-valuable"></span>/<span class="stat-icon btn-artifact"></span>)</th>
                  <td id="stat-loot-rec">0 / 0 / 0</td></tr>
          </table>
          <table class="stats-table" style="margin-top: 10px;">
              <tr><th data-i18n="stat_highlight_fastest">Fastest Turn</th><td id="stat-fast-turn" style="color:#7fff7f;">-</td></tr>
              <tr><th data-i18n="stat_highlight_slowest">Longest Turn</th><td id="stat-slow-turn" style="color:#ff7f7f;">-</td></tr>
          </table>
          <div class="stats-nav">
              <div class="nav-arrow" onclick="Game.cycleStatsPlayer(-1)">&lt;</div>
              <button class="export-btn" data-i18n="btn_export_data" onclick="Game.exportStats()">Export Data</button>
              <div class="nav-arrow" onclick="Game.cycleStatsPlayer(1)">&gt;</div>
          </div>
      </div>
      <div class="horizontal-action-row" style="margin-top: 10px;">
          <div class="btn-wrapper">
              <span class="btn-label" data-i18n="btn_timeline">Timeline</span>
              <div class="btn btn-endturn" onclick="Game.showTimeline()"></div>
          </div>
          <div class="btn-wrapper">
              <span class="btn-label" data-i18n="btn_back">Back</span>
              <div class="btn btn-rules" onclick="Game.showScreen('screen-win')"></div>
          </div>
      </div>
  </div>

  <!-- Confirmation Overlay -->
  <div id="confirm-overlay" class="screen" style="display:none; position:fixed; background:rgba(0,0,0,0.9); z-index:10000; inset:0;">
      <h1 id="confirm-msg" data-i18n="confirm_msg_default">Are you sure?</h1>
      <div class="control-row">
          <div class="btn-wrapper">
              <span class="btn-label" data-i18n="btn_confirm">Confirm</span>
              <div class="btn btn-confirm" onclick="Game.confirmAction(true)">‚úÖ</div>
          </div>
          <div class="btn-wrapper">
              <span class="btn-label" data-i18n="btn_cancel">Cancel</span>
              <div class="btn" style="background-color: #622127; display: flex; align-items: center; justify-content: center; font-size: 3rem;" onclick="Game.confirmAction(false)">‚ùå</div>
          </div>
      </div>
  </div>

  <!-- TIMELINE OVERLAY -->
  <div id="timeline-overlay">
      <div class="timeline-title-bar">
          <h2 data-i18n="timeline_title">Timeline</h2>
          <div class="timeline-close" onclick="Game.hideTimeline()">‚úñ</div>
      </div>
      <div id="timeline-container">
          <div id="timeline-content"></div>
      </div>
  </div>

  <!-- OPTIONS MENU: Toggle Button (Mobile) -->
  <div id="options-btn" onclick="Game.toggleOptionsMenu()">‚öôÔ∏è</div>

  <!-- OPTIONS MENU: Content (Desktop Sidebar / Mobile Overlay) -->
  <div id="options-menu">
      <div class="vol-wrapper">
          <div id="mute-btn" onclick="Game.toggleMute()">üîä</div>
          <div class="slider-container"><input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" oninput="Game.setVolume(this.value)"></div>
      </div>
      <div class="lang-wrapper">
        <div id="lang-btn" onclick="Game.toggleLanguageMenu()"><span id="current-lang-icon">üåê</span></div>
        <div id="lang-submenu"></div>
      </div>
      <div class="autoplay-container">
          <span class="autoplay-label" data-i18n="btn_autoplay">Autoplay Overworld Music</span>
          <div id="autoplay-toggle" class="toggle-btn active" onclick="Game.toggleAutoplay()"></div>
      </div>
      <button id="pwa-install-btn" class="pwa-btn" data-i18n="btn_install">Install App</button>
      <button class="pwa-btn" data-i18n="btn_update" onclick="Game.forceUpdate()">Force Update</button>
      <a href="https://github.com/exevirus/h3omm_bgm" target="_blank" class="github-link" data-i18n="btn_github">App Github Repository</a>
  </div>

  <script src="locale.js"></script>
  <script src="helper.js"></script>
  <script>
    let currentPlayerCount = 3;
    function updateCount(delta) {
        currentPlayerCount += delta;
        if (currentPlayerCount < 1) currentPlayerCount = 1;
        if (currentPlayerCount > 11) currentPlayerCount = 11;
        document.getElementById('p-count-display').innerText = currentPlayerCount;
    }
  </script>
</body>
</html>
