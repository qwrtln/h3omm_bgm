<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HoMM3 Companion</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@pwabuilder/pwaupdate"></script>
  
  <style>
    :root {
      --bg-color: #1a1a1a;
      --btn-size: 130px;
      --gold-color: #FFD700; 
      --gold-gradient: linear-gradient(45deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C,#FCF6BA, #B38728, #FBF5B7, #AA771C);
      --faction-color: #333; /* Default, updates via JS */
    }

    body {
      background-color: var(--bg-color);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
    }

    #game-frame {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 9999;
        border: 7px solid;
        border-image-source: var(--gold-gradient);
        border-image-slice: 4;
        box-shadow: 
            inset 0 0 0 10px var(--faction-color),
            inset 0 0 10px rgba(0,0,0,0.5);
        transition: box-shadow 0.5s ease;
    }

    .screen {
      display: none; 
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      gap: 15px;
      box-sizing: border-box;
      padding: 30px; 
    }

    h1, h2 {
      font-size: 1.8rem;
      margin: 5px;
      color: var(--gold-color);
      text-transform: uppercase;
      text-shadow: 2px 2px 0px #000, 0 0 10px rgba(255, 215, 0, 0.5);
      letter-spacing: 1px;
      text-align: center;
    }

    .name-edit-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        background: rgba(0,0,0,0.5);
        padding: 5px 15px;
        border-radius: 10px;
        border: 1px solid #444;
    }
    
    .edit-icon {
        cursor: pointer;
        font-size: 1.5rem;
        color: white; 
        transition: transform 0.2s;
        background: #333;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 1px solid var(--gold-color);
        box-shadow: 0 2px 5px black;
        pointer-events: auto; 
    }
    
    .edit-icon:active {
        transform: scale(0.9);
        background: #555;
    }

    /* Grids */
    .grid-2x2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    /* NEW 3-COLUMN GRID for Theme Selection */
    .grid-3col {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        /* Adjust size for smaller screens or lots of buttons */
    }
    .grid-3col .btn {
        height: 100px; /* Slightly smaller for the 9-grid */
    }
    .grid-3col .btn-wrapper {
        width: 100px;
    }

    .horizontal-action-row {
        display: flex;
        flex-direction: row; 
        flex-wrap: nowrap;   
        justify-content: center;
        align-items: flex-start;
        gap: 15px;
        width: 100%;
    }

    .overworld-layout {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        width: 100vw; 
    }

    #overworld-faction-subtitle {
        font-size: 1.1rem;
        color: var(--faction-color);
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 2px;
        text-shadow: 
            -1px -1px 0 #000,  
            1px -1px 0 #000,
            -1px  1px 0 #000,
            1px  1px 0 #000,
            0px  0px 5px rgba(0,0,0,0.8);
        margin-top: -15px; 
        margin-bottom: -5px; 
        z-index: 10;
    }

    #overworld-title {
        margin-bottom: 10px;
    }

    .grid-top-quadrant {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        position: relative;
        width: fit-content;
    }

    /* Desktop Volume (omitted detailed style for brevity, same as previous) */
    #desktop-volume-ctrl { position: fixed; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; gap: 20px; background: rgba(0, 0, 0, 0.9); padding: 20px 10px; border: 2px solid #555; box-shadow: 0 0 0 2px #BF953F, 0 0 15px black; border-radius: 30px; z-index: 10001; width: 40px; }
    #mute-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; filter: drop-shadow(0 0 2px gold); }
    #mute-btn.is-muted { filter: grayscale(1); opacity: 0.7; }
    .slider-container { position: relative; width: 30px; height: 150px; display: flex; align-items: center; justify-content: center; }
    #volume-slider { -webkit-appearance: none; appearance: none; background: transparent; width: 150px; height: 30px; transform: rotate(-90deg); transform-origin: center; cursor: pointer; outline: none; }
    #volume-slider::-webkit-slider-runnable-track { width: 100%; height: 8px; background: #111; border: 1px solid #444; border-radius: 4px; }
    #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #15a5e2; border: 2px solid #dcdcdc; margin-top: -9px; }
    @media (max-width: 1024px) { #desktop-volume-ctrl { display: none; } }

    @media (max-width: 430px) { :root { --btn-size: 110px; } .grid-3col .btn { height: 90px; } .grid-3col .btn-wrapper { width: 90px; } }
    @media (max-width: 350px) { :root { --btn-size: 95px; } .grid-3col .btn { height: 80px; } .grid-3col .btn-wrapper { width: 80px; } }

    .faction-container { display: flex; flex-direction: column; gap: 8px; align-items: center; }
    .faction-row { display: flex; gap: 10px; justify-content: center; }

    .btn-wrapper { display: flex; flex-direction: column; align-items: center; width: var(--btn-size); }
    .btn-label { font-size: 0.8rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; margin-bottom: 4px; text-align: center; white-space: nowrap; overflow: hidden; width: 100%; }

    .btn {
      width: 100%;
      height: var(--btn-size);
      border: 2px solid #555;
      border-radius: 15px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-color: #333;
      box-shadow: 0 5px 8px rgba(0,0,0,0.6);
      cursor: pointer;
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.6); }

    /* Overlays */
    #click-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; cursor: pointer; }

    #event-overlay {
        position: fixed;      /* Pulls it out of the quadrant to cover the WHOLE screen */
        inset: 0;             /* Stretches to all 4 corners */
        z-index: 9999;        /* Sits on top of all buttons */
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(0,0,0,0.7); /* Blocks clicks & dims the background */
        background-image: url('assets/newtime.avif');
        background-repeat: no-repeat;
        background-position: center;
        background-size: 300px 300px; /* Keeps the image height fixed at 300px */
    }
    #event-text { font-size: 1.8rem; color: var(--gold-color); text-shadow: 3px 3px 0 #000; text-align: center; font-weight: bold; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px; max-width: 90%; }

    .counter-box { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    #p-count-display { font-size: 4rem; font-weight: bold; color: white; }
    .control-row { display: flex; gap: 20px; }
    .ctrl-btn { font-size: 2rem; width: 60px; height: 60px; border-radius: 10px; background: #444; border: 1px solid gold; color: gold; }

    /* Images */
    .btn-good { background-image: url('assets/good.avif'); }
    .btn-evil { background-image: url('assets/evil.avif'); }
    .btn-neutral { background-image: url('assets/neutral.avif'); }
    .btn-secret { background-image: url('assets/secret.avif'); }

    .btn-castle { background-image: url('assets/castle.avif'); }
    .btn-rampart { background-image: url('assets/rampart.avif'); }
    .btn-tower { background-image: url('assets/tower.avif'); }
    .btn-inferno { background-image: url('assets/inferno.avif'); }
    .btn-dungeon { background-image: url('assets/dungeon.avif'); }
    .btn-necropolis { background-image: url('assets/necropolis.avif'); }
    .btn-fortress { background-image: url('assets/fortress.avif'); }
    .btn-stronghold { background-image: url('assets/stronghold.avif'); }
    .btn-conflux { background-image: url('assets/conflux.avif'); }
    .btn-cove { background-image: url('assets/cove.avif'); }
    .btn-factory { background-image: url('assets/factory.avif'); }

    /* Terrains */
    .btn-dirt { background-image: url('assets/dirt.avif'); }
    .btn-grass { background-image: url('assets/grass.avif'); }
    .btn-lava { background-image: url('assets/lava.avif'); }
    .btn-rough { background-image: url('assets/rough.avif'); }
    .btn-sand { background-image: url('assets/sand.avif'); }
    .btn-snow { background-image: url('assets/snow.avif'); }
    .btn-swamp { background-image: url('assets/swamp.avif'); }
    .btn-underground { background-image: url('assets/underground.avif'); }
    .btn-water { background-image: url('assets/water.avif'); }
    .btn-wasteland { background-image: url('assets/wasteland.avif'); }

    .btn-start { background-image: url('assets/start.avif'); }
    .btn-resource { background-image: url('assets/resource.avif'); }
    .btn-valuable { background-image: url('assets/valuable.avif'); }
    .btn-gold { background-image: url('assets/gold.avif'); }
    .btn-artifact { background-image: url('assets/artifact.avif'); }
    .btn-endturn { background-image: url('assets/end_turn.avif'); }
    .btn-rules { background-image: url('assets/rules.avif'); }
    .btn-wingame { background-image: url('assets/win_game.avif'); }
    .btn-losegame { background-image: url('assets/lose.avif'); }
    .btn-eliminated { background-image: url('assets/eliminated.avif'); }
    
    .btn-victory { background-image: url('assets/victory.avif'); }
    .btn-retreat { background-image: url('assets/retreat.avif'); }
    .btn-lose { background-image: url('assets/lose.avif'); }
    
    .btn-confirm { background-color: #28a745; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
    .btn.disabled { filter: brightness(0.4); cursor: not-allowed; pointer-events: none; border-color: #333; }

    @media (max-width: 380px) { :root { --btn-size: 100px; } }
    @media (max-height: 700px) { .screen { gap: 8px; } h1,h2 { font-size: 1.4rem; } }
  </style>
</head>
<body>

  <pwa-update swpath="sw.js"></pwa-update>

  <div id="game-frame"></div>

  <div id="click-overlay" onclick="Game.init()">
    <h1>H3 Board Game<br>Music Companion</h1>
    <p style="color: #ccc;">Click to Setup</p>
  </div>

  <!-- SCREEN 1: Theme -->
  <div id="screen-start" class="screen">
    <h1>Select Mission Theme</h1>
    <div class="grid-2x2">
        <div class="btn-wrapper"><span class="btn-label">Good</span><div class="btn btn-good" onclick="Game.selectTheme('good')"></div></div>
        <div class="btn-wrapper"><span class="btn-label">Evil</span><div class="btn btn-evil" onclick="Game.selectTheme('evil')"></div></div>
        <div class="btn-wrapper"><span class="btn-label">Neutral</span><div class="btn btn-neutral" onclick="Game.selectTheme('neutral')"></div></div>
        <div class="btn-wrapper"><span class="btn-label">Secret</span><div class="btn btn-secret" onclick="Game.selectTheme('secret')"></div></div>
    </div>
  </div>

  <!-- SCREEN 2: Player Count -->
  <div id="screen-players" class="screen">
    <h1>Player Count</h1>
    <div class="counter-box">
        <div class="control-row">
            <button class="ctrl-btn" onclick="updateCount(-1)">-</button>
            <div id="p-count-display">3</div>
            <button class="ctrl-btn" onclick="updateCount(1)">+</button>
        </div>
        <div class="btn-wrapper"><span class="btn-label">Confirm</span><div class="btn btn-confirm" onclick="Game.confirmPlayerCount(currentPlayerCount)">‚úÖ</div></div>
    </div>
  </div>

  <!-- SCREEN 3: Faction Selection -->
  <div id="screen-factions" class="screen">
    <div class="name-edit-container">
        <h2 id="faction-player-title">Player 1</h2>
        <div class="edit-icon" onclick="Game.editName()">‚úèÔ∏è</div>
    </div>
    
    <div class="faction-container">
        <div class="faction-row">
            <div class="btn-wrapper"><span class="btn-label">Castle</span><div class="btn btn-castle faction-btn" data-faction="castle"></div></div>
            <div class="btn-wrapper"><span class="btn-label">Rampart</span><div class="btn btn-rampart faction-btn" data-faction="rampart"></div></div>
            <div class="btn-wrapper"><span class="btn-label">Tower</span><div class="btn btn-tower faction-btn" data-faction="tower"></div></div>
        </div>
        <div class="faction-row">
            <div class="btn-wrapper"><span class="btn-label">Inferno</span><div class="btn btn-inferno faction-btn" data-faction="inferno"></div></div>
            <div class="btn-wrapper"><span class="btn-label">Dungeon</span><div class="btn btn-dungeon faction-btn" data-faction="dungeon"></div></div>
            <div class="btn-wrapper"><span class="btn-label">Necropolis</span><div class="btn btn-necropolis faction-btn" data-faction="necropolis"></div></div>
        </div>
        <div class="faction-row">
            <div class="btn-wrapper"><span class="btn-label">Fortress</span><div class="btn btn-fortress faction-btn" data-faction="fortress"></div></div>
            <div class="btn-wrapper"><span class="btn-label">Stronghold</span><div class="btn btn-stronghold faction-btn" data-faction="stronghold"></div></div>
        </div>
        <div class="faction-row">
            <div class="btn-wrapper"><span class="btn-label">Conflux</span><div class="btn btn-conflux faction-btn" data-faction="conflux"></div></div>
            <div class="btn-wrapper"><span class="btn-label">Cove</span><div class="btn btn-cove faction-btn" data-faction="cove"></div></div>
            <div class="btn-wrapper"><span class="btn-label">Factory</span><div class="btn btn-factory faction-btn" data-faction="factory"></div></div>
        </div>
    </div>
  </div>

  <!-- SCREEN 3.5: Pre-Game -->
  <div id="screen-pregame" class="screen">
      <h1>Ready?</h1>
      <div class="btn-wrapper">
          <span class="btn-label">Start Game</span>
          <div class="btn btn-start" style="transform: scale(1.5);" onclick="Game.startGame()"></div>
      </div>
  </div>

  <!-- SCREEN 4: Overworld -->
  <div id="screen-overworld" class="screen">
    <h1 id="overworld-title">Player 1's Turn</h1>
    <div id="overworld-faction-subtitle">Castle</div> 
    <div class="overworld-layout">

      <div class="grid-top-quadrant">
          <div id="event-overlay">
              <div id="event-text"></div>
          </div>
          <div id="resource-popup" style="display:none; position:absolute; inset:-25px; background:rgba(0,0,0,0.85); z-index:100; flex-direction:column; justify-content:center; align-items:center; border-radius:15px; border:2px solid var(--gold-color);">
                <h2 style="font-size: 1.2rem;">Select Pickup</h2>
                <div class="control-row">
                    <div class="btn-wrapper">
                        <span class="btn-label">Treasure</span>
                        <div class="btn btn-gold" onclick="Game.handleResourceChoice('gold')"></div>
                    </div>
                    <div class="btn-wrapper">
                        <span class="btn-label">Resource</span>
                        <div class="btn btn-valuable" onclick="Game.handleResourceChoice('valuable')"></div>
                    </div>
                </div>
                <div class="btn-wrapper">
                    <span class="btn-label">Artifact</span>
                    <div class="btn btn-artifact" onclick="Game.handleResourceChoice('artifact')"></div>
                </div>
          </div>
          <div class="btn-wrapper"><span class="btn-label">Battle</span><div class="btn btn-start" onclick="Game.startCombat()"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Pickup</span><div class="btn btn-resource" onclick="Game.handleResource()"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Eliminate Player</span><div class="btn btn-eliminated" onclick="Game.askEliminate()"></div></div>
          <div class="btn-wrapper"><span class="btn-label">End Turn</span><div class="btn btn-endturn" onclick="Game.endTurn()"></div></div>
      </div>

      <!-- Theme Button Updated -->
      <div class="horizontal-action-row">
          <div class="btn-wrapper"><span class="btn-label">Rules</span><div class="btn btn-rules" onclick="Game.showRules('screen-overworld')"></div></div>
          <div class="btn-wrapper">
              <span class="btn-label">Change Theme</span>
              <!-- Image will be updated via JS to match current theme -->
              <div id="btn-theme-toggle" class="btn" onclick="Game.openThemeSelector()"></div>
          </div>
      </div>

      <div class="horizontal-action-row">
          <div class="btn-wrapper"><span class="btn-label">Win</span><div class="btn btn-wingame" onclick="Game.winGame()"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Lose</span><div class="btn btn-losegame" onclick="Game.loseGame()"></div></div>
      </div>
    </div>
  </div>

  <!-- NEW SCREEN 4.5: Theme Selector -->
  <div id="screen-theme-select" class="screen">
      <h1>Select Theme</h1>
      
      <!-- Row 1: Faction Town -->
      <div class="btn-wrapper">
          <span class="btn-label" id="theme-faction-label">Town</span>
          <div id="theme-faction-btn" class="btn"></div>
      </div>

      <!-- Rows 2-4: Terrains (Grid) -->
      <div class="grid-3col">
          <div class="btn-wrapper"><span class="btn-label">Dirt</span><div class="btn btn-dirt" onclick="Game.applyThemeSelection('dirt')"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Grass</span><div class="btn btn-grass" onclick="Game.applyThemeSelection('grass')"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Lava</span><div class="btn btn-lava" onclick="Game.applyThemeSelection('lava')"></div></div>
          
          <div class="btn-wrapper"><span class="btn-label">Rough</span><div class="btn btn-rough" onclick="Game.applyThemeSelection('rough')"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Sand</span><div class="btn btn-sand" onclick="Game.applyThemeSelection('sand')"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Snow</span><div class="btn btn-snow" onclick="Game.applyThemeSelection('snow')"></div></div>
          
          <div class="btn-wrapper"><span class="btn-label">Swamp</span><div class="btn btn-swamp" onclick="Game.applyThemeSelection('swamp')"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Underground</span><div class="btn btn-underground" onclick="Game.applyThemeSelection('underground')"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Water</span><div class="btn btn-water" onclick="Game.applyThemeSelection('water')"></div></div>

          <div class="btn-wrapper"></div>
          <div class="btn-wrapper"><span class="btn-label">Wasteland</span><div class="btn btn-wasteland" onclick="Game.applyThemeSelection('wasteland')"></div></div>
      </div>
  </div>

  <!-- SCREEN 5: Combat -->
  <div id="screen-combat" class="screen">
    <h1 id="combat-title">Player 1's Combat</h1>
    
    <div style="position: relative;">
      <div id="combat-event-overlay" onclick="Game.returnToOverworld()" style="
        position: absolute;
        inset: -10px;
        background-color: rgba(0,0,0,0.8);
        background-repeat: no-repeat;
        background-position: center;
        background-size: cover;
        z-index: 900;
        border-radius: 20px;
        box-shadow: 0 0 15px #000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border: 2px solid var(--gold-color);
        cursor: pointer; 
      ">
        <div id="combat-event-text" style="
          font-size: 1.8rem;
          color: var(--gold-color);
          text-shadow: 3px 3px 0 #000;
          text-align: center;
          font-weight: bold;
          background: rgba(0,0,0,0.6);
          padding: 10px;
          border-radius: 10px;
        "></div>
      </div>

      <div class="grid-2x2">
          <div class="btn-wrapper"><span class="btn-label">Win</span><div class="btn btn-victory" onclick="Game.combatVictory()"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Retreat</span><div class="btn btn-retreat" onclick="Game.combatRetreat()"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Lose</span><div class="btn btn-lose" onclick="Game.combatLose()"></div></div>
          <div class="btn-wrapper"><span class="btn-label">Rules</span><div class="btn btn-rules" onclick="Game.showRules('screen-combat')"></div></div>
      </div>
    </div>
  </div>

  <!-- SCREEN 6: Rules -->
  <div id="screen-rules" class="screen">
      <h1>Consulting Rules</h1>
      <div class="btn-wrapper"><span class="btn-label">Back</span><div class="btn btn-rules" style="transform: scale(1.5);" onclick="Game.exitRules()"></div></div>
  </div>

  <!-- SCREEN 7: Win/Lose Result -->
  <div id="screen-win" class="screen">
      <h1 id="endgame-title">Victory!</h1>
      <div class="btn-wrapper">
          <span class="btn-label">New Game</span>
          <div id="win-theme-btn" class="btn" style="transform: scale(1.5);" onclick="Game.resetGame()"></div>
      </div>
  </div>

  <!-- Confirmation Overlay -->
  <div id="confirm-overlay" class="screen" style="display:none; position:fixed; background:rgba(0,0,0,0.9); z-index:10000; inset:0;">
      <h1 id="confirm-msg">Are you sure?</h1>
      <div class="control-row">
          <div class="btn-wrapper">
              <span class="btn-label">Confirm</span>
              <div class="btn btn-confirm" onclick="Game.confirmAction(true)">‚úÖ</div>
          </div>
          <div class="btn-wrapper">
              <span class="btn-label">Cancel</span>
              <div class="btn" style="background-color: #622127; display: flex; align-items: center; justify-content: center; font-size: 3rem;" onclick="Game.confirmAction(false)">‚ùå</div>
          </div>
      </div>
  </div>

  <!-- Volume Sidebar -->
  <div id="desktop-volume-ctrl">
      <div id="mute-btn" onclick="Game.toggleMute()">üîä</div>
      <div class="slider-container">
          <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" oninput="Game.setVolume(this.value)">
      </div>
  </div>

  <script src="helper.js"></script>
  <script>
    let currentPlayerCount = 3;
    function updateCount(delta) {
        currentPlayerCount += delta;
        if (currentPlayerCount < 1) currentPlayerCount = 1;
        if (currentPlayerCount > 10) currentPlayerCount = 10;
        document.getElementById('p-count-display').innerText = currentPlayerCount;
    }
  </script>
</body>
</html>
